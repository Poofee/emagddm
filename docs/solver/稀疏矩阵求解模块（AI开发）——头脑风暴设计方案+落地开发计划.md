# 稀疏矩阵求解模块（AI开发）——头脑风暴设计方案+落地开发计划

（适配低频电磁有限元框架·串行/分布式/FETI-DP·MPI+OpenMP混合编程·实/复矩阵+块稀疏）

## 第一部分：稀疏矩阵求解模块 头脑风暴设计方案

核心原则：**贴合现有框架（DOF管理、稀疏矩阵、MPI+OpenMP）、聚焦低频电磁场景、模块化解耦、可扩展、高性能、低侵入**，围绕“求解算法适配、场景落地、工程化协同”三大核心展开头脑风暴，覆盖全维度设计要点，避免冗余且贴合实际开发需求。

### 一、核心定位与设计边界（明确AI开发范围，不越界）

1. 核心定位：作为有限元框架的「核心计算终端」，接收稀疏矩阵模块组装后的矩阵（COO/CSR/块稀疏、实/复），结合DOF管理的边界/界面约束，通过适配的求解算法，输出满足精度要求的解向量，支撑低频电磁算例（静电/静磁/涡流）全流程求解。

2. 设计边界（不做冗余开发）：

    - 不重复实现稀疏矩阵存储（复用现有COO/CSR/块稀疏结构）；

    - 不独立实现边界/界面约束（复用DOF管理的边界标记、界面提取结果）；

    - 不独立实现并行/分布式通信（复用MPI+OpenMP封装层，聚焦求解器计算并行）；

    - 不超前实现非核心算法（优先适配低频电磁常用算法，后续预留扩展接口）。

### 二、核心设计维度（头脑风暴关键要点，AI必覆盖）

#### （一）求解算法选型（贴合场景，拒绝“大而全”，优先常用、高效）

算法选型核心：**适配低频电磁稀疏矩阵特点（对称/非对称、实/复、高稀疏度、大规模DOF）、兼顾收敛速度与计算开销、支持串行/分布式/FETI-DP**，分三类选型，明确优先级。

|算法类型|具体算法|适配场景|优先级|核心说明|
|---|---|---|---|---|
|串行迭代求解器（基础）|CG（共轭梯度法）|实对称正定矩阵（静电/静磁标量元）|最高|核心常用，优先实现，优化内存开销|
|串行迭代求解器（基础）|GMRES（广义最小残差法）|非对称/奇异矩阵（复杂静磁/涡流）|高|适配非对称场景，补充CG的局限性|
|串行迭代求解器（进阶）|BiCGSTAB（双共轭梯度稳定法）|非对称实矩阵、低收敛难度场景|中|作为GMRES的补充，提升部分场景收敛速度|
|串行迭代求解器（进阶）|CGNR（共轭梯度法求解正规方程）|复矩阵、非对称复矩阵（涡流场）|高|核心适配电磁复矩阵场景，优先实现|
|预处理算法（核心配套）|ILU(0)（不完全LU分解）|串行/分布式，各类矩阵预处理|最高|轻量化、高效，适配大规模DOF，优先实现|
|预处理算法（核心配套）|SSOR（对称逐次超松弛）|对称矩阵预处理，补充ILU(0)|中|适配对称矩阵，提升CG收敛速度|
|预处理算法（进阶）|块ILU（Block-ILU）|块稀疏矩阵（矢量元边DOF，2×2/3×3块）|高|适配电磁矢量元场景，必须实现|
|分布式求解器（基础）|分布式CG/GMRES|MPI多进程，全局矩阵分布式存储求解|高|适配分布式稀疏矩阵，基于MPI通信|
|分布式求解器（进阶）|FETI-DP专用求解器|分布式子域拆分，界面耦合求解（框架核心）|最高|适配稀疏矩阵阶段5的FETI-DP矩阵，必须实现|
|备用算法（预留接口）|AMG（代数多重网格法）|超大规模DOF（千万级+），快速收敛|低|阶段6后可选实现，预留接口，不优先开发|
#### （二）模块架构设计（模块化、解耦、统一接口，贴合现有框架）

遵循“**分层设计+统一接口+无感适配**”原则，架构分5层，每层职责清晰，与现有模块无缝对接，避免耦合，同时遵循“串行=1进程分布式”统一框架，无代码冗余。

1. 接口层（最上层，用户/框架调用入口）

    - 核心职责：提供统一的求解器接口，屏蔽底层算法、并行模式差异，用户无需关注细节，一键调用。

    - 关键设计：

        - 统一求解接口：`solve(const SparseMatrix& A, const Vector& b, Vector& x)`，支持所有求解器、所有矩阵类型；

        - 求解器配置接口：`set_solver_param()`（设置迭代次数、收敛精度、预处理类型）；

        - 结果查询接口：`get_iter_count()`、`get_residual()`、`is_converged()`；

        - 无感适配：自动识别矩阵类型（实/复、块稀疏/普通稀疏）、并行模式（串行/OpenMP/MPI/混合），无需用户手动配置。

2. 求解器核心层（核心层，算法实现）

    - 核心职责：实现所有求解算法，按“串行求解器、分布式求解器、FETI-DP求解器”拆分，模块化实现，互不干扰。

    - 关键设计：

        - 串行求解器模块：封装`CGSolver`、`GMRESSolver`、`BiCGSTABSolver`、`CGNRSolver`类，继承统一基类`SerialSolver`；

        - 分布式求解器模块：封装`DistributedCGSolver`、`DistributedGMRESSolver`，继承统一基类`DistributedSolver`，对接MPI封装层；

        - FETI-DP求解器模块：封装`FETIDPSolver`，专门适配FETI-DP框架的子域矩阵、界面约束矩阵Bᵢ、耦合矩阵F，对接界面DOF提取模块；

        - 基类抽象：所有求解器继承统一基类`SolverBase`，实现接口复用，减少代码冗余；

        - 第三方求解器适配模块（新增）：新增第三方求解器适配基类`ThirdPartySolverAdapter`，继承`SolverBase`，封装第三方求解器的通用调用逻辑（初始化、参数设置、求解、结果返回），统一接口规范，屏蔽不同第三方求解器的底层差异；适配模块独立封装，与自研求解器模块解耦，后期新增第三方求解器仅需实现该基类的具体接口。

3. 预处理层（辅助层，提升收敛速度）

    - 核心职责：实现所有预处理算法，作为求解器的配套，可灵活组合（如CG+ILU(0)、GMRES+SSOR）。

    - 关键设计：

        - 预处理接口统一：`preprocess(const SparseMatrix& A)`，所有预处理类继承`PreconditionerBase`；

        - 串行预处理：`ILU0Preconditioner`、`SSORPreconditioner`、`BlockILU0Preconditioner`；

        - 分布式预处理：`DistributedILU0Preconditioner`，对接MPI，实现子域预处理、跨进程预处理数据同步；

        - 灵活切换：求解器可通过配置接口，动态选择预处理类型，支持“无预处理”模式。

4. 适配层（衔接层，对接现有模块）

    - 核心职责：实现求解模块与现有框架其他模块的无缝对接，不侵入其他模块核心逻辑，仅通过接口交互。

    - 关键设计：

        - 对接稀疏矩阵模块：支持读取COO/CSR/块稀疏矩阵数据，支持并行组装后的矩阵直接传入求解；

        - 对接DOF管理模块：获取边界DOF（用于应用Dirichlet边界条件）、界面DOF（用于FETI-DP求解）、周期性DOF映射（用于融合周期约束）；

        - 对接MPI+OpenMP模块：分布式求解用MPI实现进程间通信（残差同步、解向量同步），进程内用OpenMP实现并行计算（残差计算、矩阵乘向量）；

        - 对接计时工具模块：统计求解各阶段耗时（预处理耗时、迭代耗时、通信耗时），对接“进程-线程-模块”三级计时；

        - 对接内存管理模块：预分配求解过程中的向量（残差向量、搜索方向向量、临时向量）、临时矩阵，避免动态扩容，实现缓存行对齐。

5. 辅助层（支撑层，保障鲁棒性与易用性）

    - 核心职责：提供收敛判断、残差计算、参数校验、日志输出等辅助功能，保障求解器稳定运行。

    - 关键设计：

        - 收敛判断模块：实现多种收敛准则（残差相对误差、残差绝对误差、迭代次数上限），可配置；

        - 残差计算模块：优化残差计算逻辑（r = b - A*x），支持并行计算（OpenMP多线程、MPI分布式）；

        - 参数校验模块：校验求解器参数（迭代次数≥1、收敛精度>0）、矩阵维度（A的列数= b的长度）、DOF索引合法性；

        - 日志输出模块：对接spdlog，输出求解过程日志（迭代次数、残差变化、预处理类型、并行模式），支持不同日志级别。

#### （三）场景适配设计（聚焦低频电磁，贴合框架现有场景）

1. 实/复矩阵适配：

    - 所有求解器、预处理算法均支持实矩阵（float/double）、复矩阵（complex<float>/complex<double>）；

    - 适配电磁场景：实矩阵用于静电/静磁，复矩阵用于涡流场（考虑相位变化）；

    - 底层计算优化：复矩阵乘法、残差计算做专门优化，避免冗余计算。

2. 块稀疏矩阵适配（矢量元边DOF核心）：

    - 预处理层实现块ILU(0)预处理，适配2×2/3×3块稀疏矩阵（矢量元边DOF对应的单元矩阵）；

    - 求解器核心层优化矩阵乘向量、向量乘向量操作，适配块稀疏存储结构，避免块拆分带来的性能损耗；

    - 对接DOF管理的边DOF邻接关系，确保块稀疏矩阵的块索引与DOF映射一致。

3. 边界/周期性约束适配：

    - 对接DOF管理的`get_dirichlet_dofs()`，在求解前应用Dirichlet边界条件（将边界DOF对应的行/列置零、对角元置1，解向量对应位置赋值边界值）；

    - 对接DOF管理的`get_periodic_dof_pair()`，在求解过程中融合周期性约束，将周期性DOF的解向量关联，提升求解正确性；

    - 约束应用时机：优先在预处理前应用，避免约束对预处理矩阵的影响。

4. 并行模式适配（MPI+OpenMP混合编程）：

    - 串行模式：1进程+1线程，自动退化，无额外代码分支；

    - OpenMP多线程模式：进程内用OpenMP并行计算残差、矩阵乘向量、预处理矩阵乘向量，提升单进程求解速度；

    - MPI分布式模式：多进程分域，每个进程求解子域局部矩阵，通过MPI实现残差同步、解向量同步；

    - 混合模式（MPI+OpenMP）：MPI分进程，每个进程内用OpenMP多线程并行计算，兼顾分布式分域与进程内并行效率。

5. FETI-DP场景适配（框架核心场景）：

    - 专门封装`FETIDPSolver`，对接稀疏矩阵阶段5的子域刚度矩阵Kᵢ、界面约束矩阵Bᵢ、耦合矩阵F；

    - 实现FETI-DP核心流程：子域求解→界面约束应用→耦合矩阵计算→全局校正→迭代收敛；

    - 对接界面DOF提取模块的`InterfaceDofExtractor`，获取界面DOF主从标记、邻接关系，支撑界面耦合计算；

    - 通信优化：仅在界面DOF处做MPI通信，批量同步界面残差、解向量，减少通信量。

#### （四）性能优化设计（工程化关键，避免求解成为性能瓶颈）

1. 内存优化：

    - 所有向量（残差向量r、搜索方向向量p、临时向量z等）均通过内存管理工具预分配容量，复用内存，避免动态扩容；

    - 预处理矩阵、临时矩阵与稀疏矩阵共享内存（如ILU(0)预处理矩阵复用原矩阵的非零元存储结构），减少内存占用；

    - 缓存优化：向量、临时数据按缓存行对齐（对接内存管理的`CacheLineAligner`），避免伪共享，提升内存访问效率；

    - 小向量优化：小规模DOF（万级以下）时，使用栈上内存，避免堆内存分配开销。

2. 计算优化：

    - 矩阵乘向量、向量乘向量操作优化：手动优化循环逻辑，适配CPU指令集（SSE/AVX），或对接BLAS接口（如OpenBLAS），提升计算速度；

    - 迭代优化：动态调整迭代步长，根据残差变化自适应调整收敛准则，避免无效迭代；

    - 预处理优化：ILU(0)预处理采用稀疏存储，仅存储非零元，减少预处理计算量；块ILU(0)预处理复用块稀疏结构，避免块拆分。

3. 通信优化（分布式/混合模式）：

    - MPI通信优化：采用非阻塞通信（isend/irecv）替代阻塞通信，减少进程等待时间；界面DOF数据批量同步，减少通信次数；

    - 数据压缩：跨进程传输的残差、解向量采用简单压缩（如只传输非零元、界面DOF数据），减少通信量；

    - 负载均衡：MPI进程间按DOF规模均匀拆分任务，OpenMP线程间按计算量拆分任务，避免进程/线程空闲。

#### （五）鲁棒性与易用性设计（工程化落地关键）

1. 鲁棒性设计：

    - 异常处理：捕获求解过程中的异常（矩阵奇异、收敛失败、参数非法、内存不足、MPI通信失败），抛出明确异常（如`SolverException`），附带详细错误信息（迭代次数、残差、进程ID、错误类型）；

    - 收敛失败处理：提供重试机制，可配置重试次数、重试时调整预处理参数；收敛失败后输出详细日志，方便定位问题；

    - 边界场景适配：支持空矩阵、奇异矩阵、小规模DOF（万级以下）、大规模DOF（千万级以上），无崩溃、无数据错乱；

    - 参数校验：所有求解器参数、矩阵参数、边界参数均做校验，非法参数直接抛出异常，避免后续计算错误。

2. 易用性设计：

    - 统一接口：所有求解器、预处理算法均通过统一接口调用，用户无需区分算法、并行模式；

    - 默认参数：提供合理的默认参数（迭代次数默认1000、收敛精度默认1e-6、预处理默认ILU(0)），用户可直接调用，无需手动配置；

    - 配置灵活：支持通过配置文件（JSON）、API接口设置求解器参数、并行模式、预处理类型；

    - 结果可视化：预留接口，支持将解向量、残差变化曲线导出，对接VTK可视化工具，方便结果分析。

#### （六）可扩展性设计（预留后续扩展空间，避免重构）

1. 算法扩展：预留求解器、预处理算法扩展接口，后续可新增AMG预处理、其他迭代求解器（如TFQMR），无需修改核心代码；

2. 场景扩展：预留多物理场适配接口，后续可适配高频电磁、弹性力学等场景的稀疏矩阵求解；

3. 硬件扩展：预留GPU适配接口，后续可对接CUDA/OpenCL，实现GPU加速求解；

4. 接口扩展：预留自定义收敛准则、自定义预处理接口，支持用户根据需求扩展；

5. 第三方求解器适配扩展（新增）：预留superlu、mumps等主流第三方求解器统一适配接口，制定标准化适配规范，确保后期接入无需修改核心代码，实现与自研求解器无感切换。

#### （七）关键问题与解决方案（提前规避开发坑）

|关键问题|解决方案|
|---|---|
|求解收敛速度慢（大规模DOF）|1. 优先用ILU(0)/块ILU(0)预处理；2. 优化迭代终止条件；3. 分布式分域减少单进程计算量；4. 后续预留AMG预处理接口|
|分布式求解数据同步错乱|1. 对接MPI封装层，使用统一通信接口；2. 界面DOF数据批量同步，增加同步校验；3. 进程间数据拆分按DOF分域，确保无重叠、无遗漏|
|块稀疏矩阵求解性能损耗|1. 优化块矩阵乘向量操作，适配块存储结构；2. 块ILU(0)预处理复用块结构，避免块拆分；3. 缓存行对齐块数据|
|混合模式（MPI+OpenMP）负载不均|1. 按“进程数×线程数”拆分任务，确保每个进程-线程任务量均匀；2. 动态负载均衡，实时调整任务分配；3. 避免进程内线程数超过CPU核心数|
|复矩阵求解效率低|1. 优化复矩阵乘法、残差计算逻辑，减少冗余计算；2. 复预处理矩阵复用实部/虚部存储，避免重复分配内存；3. 指令集优化，适配CPU对复数计算的支持|
|收敛失败（奇异矩阵）|收敛失败（奇异矩阵）<br>1. 增加参数校验，提前检测矩阵奇异性；2. 提供重试机制，调整预处理参数；3. 抛出明确异常，附带矩阵信息，方便用户排查网格/DOF问题<br>第三方求解器接口不兼容<br>1. 通过`ThirdPartySolverAdapter`基类做接口适配，统一封装调用逻辑；2. 制定标准化参数映射规则，将自研求解器参数转换为第三方求解器兼容参数；3. 预留参数自定义接口，支持特殊参数配置<br>第三方求解器数据格式不匹配<br>1. 适配层新增数据格式转换接口，将自研COO/CSR/块稀疏矩阵转换为第三方求解器支持格式（如mumps的分布式矩阵格式）；2. 复用内存管理模块，避免数据重复拷贝，提升效率<br>第三方求解器并行模式适配<br>1. 复用现有MPI+OpenMP封装层，第三方求解器并行模式通过封装层调用，与自研求解器并行逻辑统一；2. 适配层新增并行模式映射，自动匹配第三方求解器并行配置（如进程数、线程数）|
#### （八）易用性与工程化设计（落地关键）

1. 配置化：支持JSON配置文件，可配置求解器类型、迭代次数、收敛精度、预处理类型、并行模式（进程数/线程数）；

2. 日志输出：求解过程中输出详细日志（迭代次数、当前残差、预处理耗时、通信耗时），支持INFO/DEBUG/ERROR级别，方便调试；

3. Python绑定：使用pybind11封装核心接口，支持Python脚本调用求解器，设置参数、获取结果，方便脚本化测试与批量求解；

4. 测试用例：覆盖所有算法、场景、并行模式，提供小算例（验证正确性）、大规模算例（验证性能）；

5. 文档：提供详细的API手册、使用手册、场景适配说明、性能调优指南，方便用户接入与维护。

## 第二部分：稀疏矩阵求解模块 AI开发落地计划

（严格对齐现有框架6阶段开发节奏，与DOF管理、稀疏矩阵、MPI+OpenMP模块协同，分6阶段递进，测试驱动，每阶段达标后启动下一阶段，AI严格遵循）

### 一、开发整体目标（AI最终交付标准）

实现一款**适配低频电磁有限元框架、支持多算法/多场景/多并行模式、高性能、鲁棒性强、低侵入**的稀疏矩阵求解模块，核心支撑框架全流程求解，最终达成：

1. 算法覆盖：实现头脑风暴中所有“高/最高优先级”算法，预留低优先级算法扩展接口；

2. 场景适配：完美适配实/复矩阵、块稀疏/普通稀疏矩阵、边界/周期性约束、FETI-DP场景，支持低频电磁全场景（静电/静磁/涡流）；

3. 并行适配：无缝对接MPI+OpenMP模块，支持串行/OpenMP/MPI/混合四种模式，无感切换；

4. 性能达标：千万级DOF下，混合模式（4进程×8线程）求解耗时＜10s，迭代收敛速度满足工程需求（残差收敛到1e-6的迭代次数＜1000）；

5. 协同适配：与现有模块（DOF管理、稀疏矩阵、计时工具、内存管理、MPI+OpenMP）无缝协同，无耦合、无冲突；

6. 工程化可用：提供统一接口、完整测试用例、详细文档、配置文件，模块化设计，可单独编译、维护、扩展，代码覆盖率≥95%。

### 二、技术约束（AI必遵循，贴合现有框架）

1. 编程语言：C++17（与现有框架一致，禁止更高版本）；

2. 依赖模块：严格对接现有模块（DOF管理、稀疏矩阵、计时工具、内存管理、MPI+OpenMP封装层），禁止独立实现相关功能；

3. 编码规范：类名`UpperCamelCase`、函数/变量名`lower_snake_case`，关键逻辑加详细注释，代码无冗余、无内存泄漏；

4. 内存约束：所有向量、临时矩阵均通过内存管理工具预分配，缓存行对齐，禁止裸指针直接分配内存；

5. 并行约束：不直接调用MPI/OpenMP原生接口，仅通过现有封装层调用，确保并行模式无感适配；

6. 场景约束：优先适配低频电磁场景，不超前实现非核心场景（如高频电磁、弹性力学）；

7. 统一框架：严格遵循“串行=1进程分布式”设计，避免代码冗余，确保串行/分布式模式无差异。

### 三、分阶段开发计划（6阶段，与框架现有阶段一一对应，同步推进）

#### 阶段1：基础接口与串行实矩阵求解器（适配框架阶段1-2：基础COO/CSR+串行矩阵操作）

##### 阶段目标

完成求解模块的基础架构搭建，实现**统一接口层、串行实矩阵求解器（CG/GMRES）、基础预处理（ILU(0)/SSOR）**，对接稀疏矩阵阶段1-2的实矩阵（COO/CSR）、DOF管理阶段1-2的边界DOF，实现串行模式下的基础求解功能，验证正确性与基础性能。

##### 核心开发任务（AI具体操作）

1. 基础架构搭建：

    - 实现求解器统一基类`SolverBase`，定义纯虚接口（`solve()`、`set_solver_param()`、`get_iter_count()`等）；

    - 实现预处理统一基类`PreconditionerBase`，定义纯虚接口（`preprocess()`、`apply(const Vector& x, Vector& y)`）；

    - 实现辅助层基础功能：参数校验、简单收敛判断（残差相对误差）、基础日志输出（对接spdlog）；

    - 实现适配层基础功能：对接稀疏矩阵模块（读取实矩阵COO/CSR数据）、对接DOF管理模块（获取Dirichlet边界DOF）、对接内存管理模块（向量预分配）。

2. 串行实矩阵求解器实现：

    - 实现`CGSolver`、`GMRESSolver`类，继承`SerialSolver`（继承`SolverBase`）；

    - 实现核心求解逻辑：CG迭代、GMRES迭代，包含残差计算、搜索方向更新、解向量更新；

    - 实现求解器参数配置：迭代次数（默认1000）、收敛精度（默认1e-6），支持接口设置；

    - 优化核心计算：手动优化矩阵乘向量、向量乘向量操作，适配实矩阵COO/CSR结构。

3. 基础预处理实现：

    - 实现`ILU0Preconditioner`、`SSORPreconditioner`类，继承`PreconditionerBase`；

    - 实现ILU(0)、SSOR预处理逻辑，支持实矩阵COO/CSR，复用原矩阵非零元存储结构；

    - 实现预处理与求解器的对接：求解器可通过`set_preconditioner()`接口，灵活选择预处理类型。

4. 边界条件适配：

    - 实现`apply_dirichlet_boundary()`接口，对接DOF管理的`get_dirichlet_dofs()`，在求解前应用Dirichlet边界条件；

    - 验证边界应用正确性：确保边界DOF对应的解向量位置赋值正确，矩阵行/列修改符合要求。

5. 测试用例开发：

    - 编写`test_solver_serial_real.cpp`，构造小算例（1e4 DOF实对称/非对称矩阵），测试CG/GMRES求解器+ILU(0)/SSOR预处理的正确性；

    - 测试边界条件应用：构造带Dirichlet边界的小算例，验证边界适配正确性；

    - 测试计时统计：对接计时工具阶段2，统计预处理耗时、迭代耗时、总求解耗时。

##### 技术要求

1. 正确性：求解结果与理论手工计算结果一致，残差收敛到设定精度，边界条件应用正确；

2. 性能：1e4 DOF实矩阵，CG+ILU(0)求解耗时＜10ms，迭代次数＜100；

3. 鲁棒性：参数非法（迭代次数≤0、收敛精度≤0）时抛出明确异常，空矩阵、奇异矩阵能正确捕获异常；

4. 协同性：与稀疏矩阵、DOF管理、内存管理、计时工具模块无缝对接，无耦合、无冲突；

5. 接口统一：所有求解器、预处理均通过统一接口调用，屏蔽底层差异。

##### 交付物

1. 头文件：`solver_base.h`、`serial_solver.h`、`preconditioner_base.h`、`ilu0_preconditioner.h`、`ssor_preconditioner.h`、`solver_interface.h`；

2. 源文件：`serial_solver.cpp`、`ilu0_preconditioner.cpp`、`ssor_preconditioner.cpp`、`solver_aux.cpp`（辅助功能）；

3. 测试用例：`test_solver_serial_real.cpp`；

4. 临时文档：`solver_basic_api.md`（基础接口、求解器参数说明）；

5. 适配文件：修改适配层相关文件（对接现有模块的接口实现）。

##### 验证标准

1. 功能正确性：小算例求解结果与理论一致，边界条件应用正确，迭代收敛符合预期；

2. 性能达标：1e4 DOF实矩阵求解耗时、迭代次数满足技术要求；

3. 鲁棒性：异常场景无崩溃，异常信息清晰；

4. 协同性：与现有模块对接顺畅，无编译/运行错误，计时统计准确。

---

#### 阶段2：串行复矩阵与块稀疏求解器（适配框架阶段3：低频电磁场景适配）

##### 阶段目标

扩展求解模块的场景适配能力，实现**串行复矩阵求解器（CGNR）、块稀疏矩阵求解适配、块ILU(0)预处理**，对接稀疏矩阵阶段3的复矩阵、块稀疏矩阵，DOF管理阶段3的边DOF、周期性边界，适配低频电磁的涡流场、矢量元场景，验证复矩阵、块稀疏求解的正确性与性能。

##### 核心开发任务（AI具体操作）

1. 串行复矩阵求解器实现：

    - 实现`CGNRSolver`类，继承`SerialSolver`，支持复矩阵（complex<double>）求解；

    - 优化复矩阵核心计算：复矩阵乘向量、复向量乘向量、复残差计算，避免冗余计算（如共轭操作优化）；

    - 适配复矩阵场景：对接稀疏矩阵模块的复COO/CSR矩阵，支持复矩阵的预处理与求解；

    - 扩展求解器参数：支持复矩阵的收敛准则（残差的模值判断）。

2. 块稀疏矩阵适配开发：

    - 扩展适配层：对接稀疏矩阵模块的块稀疏矩阵（COO/CSR块版本），支持2×2/3×3块稀疏结构；

    - 优化串行求解器：修改`CGSolver`、`GMRESSolver`、`CGNRSolver`，适配块稀疏矩阵的矩阵乘向量、向量乘向量操作，避免块拆分；

    - 对接DOF管理的边DOF邻接关系，确保块稀疏矩阵的块索引与边DOF映射一致，避免块索引错乱。

3. 块预处理实现：

    - 实现`BlockILU0Preconditioner`类，继承`PreconditionerBase`，支持块稀疏矩阵的ILU(0)预处理；

    - 优化块预处理逻辑：复用块稀疏存储结构，对每个块单独做ILU(0)分解，减少计算量；

    - 实现块预处理与求解器的对接：支持块稀疏矩阵+块ILU(0)预处理的组合求解（如CG+BlockILU0）。

4. 周期性边界适配：

    - 扩展`apply_periodic_boundary()`接口，对接DOF管理的`get_periodic_dof_pair()`，在求解过程中融合周期性约束；

    - 约束实现逻辑：将周期性DOF的解向量关联，迭代过程中同步更新，确保周期性约束满足；

    - 验证周期性适配：构造带周期性边界的小算例（如周期性网格），验证求解正确性。

5. 测试用例开发：

    - 编写`test_solver_serial_complex.cpp`，构造复矩阵小算例（1e4 DOF，适配涡流场），测试CGNR求解器的正确性；

    - 编写`test_solver_block_sparse.cpp`，构造块稀疏矩阵小算例（矢量元边DOF，2×2块），测试块稀疏求解+块ILU(0)预处理的正确性；

    - 扩展现有测试用例，测试周期性边界适配正确性，验证复矩阵、块稀疏求解的性能；

    - 对接计时工具阶段2，统计复矩阵、块稀疏求解各阶段耗时。

##### 技术要求

1. 正确性：复矩阵求解结果的实部/虚部与理论一致，块稀疏求解无块拆分错误，周期性边界约束满足；

2. 性能：1e4 DOF复矩阵，CGNR+ILU(0)求解耗时＜20ms；1e4 DOF块稀疏矩阵，CG+BlockILU0求解耗时＜25ms；

3. 适配性：复矩阵、块稀疏矩阵、周期性边界均能自动识别，无需用户手动配置；

4. 鲁棒性：复矩阵奇异、块稀疏矩阵块维度不匹配时，能正确抛出异常，无崩溃；

5. 协同性：与DOF管理的边DOF、周期性DOF映射无缝对接，与稀疏矩阵的块稀疏模块协同顺畅。

##### 交付物

1. 新增/更新文件：`cgnr_solver.h/cpp`、`block_ilu0_preconditioner.h/cpp`，更新现有求解器、预处理、适配层文件；

2. 测试用例：`test_solver_serial_complex.cpp`、`test_solver_block_sparse.cpp`，扩展现有测试用例；

3. 文档更新：`solver_basic_api.md`（新增复矩阵、块稀疏求解相关接口、参数说明）；

4. 适配文件：更新适配层文件（对接块稀疏矩阵、周期性边界）。

##### 验证标准

1. 功能正确性：复矩阵、块稀疏矩阵求解结果正确，周期性边界约束满足，预处理效果达标；

2. 性能达标：复矩阵、块稀疏矩阵求解耗时、迭代次数满足技术要求；

3. 适配性：自动识别矩阵类型、边界类型，无需手动配置；

4. 鲁棒性：异常场景无崩溃，异常信息清晰，协同无冲突。

---

#### 阶段3：串行求解器优化与预处理增强（适配框架阶段3，提升性能）

##### 阶段目标

对现有串行求解器、预处理算法做**极致性能优化**，新增BiCGSTAB串行求解器，增强预处理算法的适配性，优化收敛速度，对接计时工具阶段3，实现串行模式下的性能最大化，支撑大规模DOF（1e5级）的串行求解，为后续分布式求解打基础。

##### 核心开发任务（AI具体操作）

1. 串行求解器优化：

    - 新增`BiCGSTABSolver`类，继承`SerialSolver`，支持实/复矩阵、普通稀疏/块稀疏矩阵，作为GMRES的补充；

    - 优化现有求解器核心计算：矩阵乘向量、向量乘向量操作对接BLAS接口（如OpenBLAS），或手动优化循环，适配CPU指令集（SSE/AVX）；

    - 收敛准则优化：新增残差绝对误差、残差变化率两种收敛准则，支持用户配置，避免无效迭代；

    - 迭代优化：动态调整迭代步长，根据残差变化自适应调整收敛精度，提升收敛速度；

    - 内存优化：求解过程中的向量（r、p、z等）复用内存，避免重复分配，缓存行对齐。

2. 预处理算法增强与优化：

    - 优化ILU(0)、SSOR、BlockILU(0)预处理算法，减少预处理计算量，提升预处理效果（降低迭代次数）；

    - 新增预处理参数配置：ILU(0)的填充因子、SSOR的松弛因子，支持用户动态调整，适配不同矩阵类型；

    - 预处理缓存优化：预处理矩阵缓存到内存，支持多次求解复用，减少重复预处理耗时；

    - 适配增强：BlockILU(0)预处理支持任意合法块维度（2×2/3×3），自动识别块稀疏矩阵的块大小。

3. 收敛速度优化：

    - 针对低频电磁矩阵特点，优化求解器初始解向量设置（默认初始解为0向量，支持用户自定义初始解）；

    - 预处理与求解器的组合优化：根据矩阵类型（对称/非对称、实/复、块稀疏），自动推荐最优预处理类型；

    - 残差计算优化：避免重复计算残差，迭代过程中复用中间结果，减少计算量。

4. 性能统计与优化验证：

    - 对接计时工具阶段3，统计求解各阶段耗时（预处理耗时、单次迭代耗时、残差计算耗时、总耗时）；

    - 编写性能优化验证代码，测试不同规模DOF（1e4、1e5）、不同矩阵类型的求解性能；

    - 针对性能瓶颈，做针对性优化（如内存访问优化、计算逻辑优化），确保性能达标。

5. 测试用例扩展：

    - 编写`test_solver_serial_optimize.cpp`，测试优化后求解器的性能（1e4、1e5 DOF），验证收敛速度提升；

    - 测试不同求解器+预处理组合的效果，对比优化前后的迭代次数、耗时；

    - 测试大规模DOF（1e5）的串行求解，验证内存优化、计算优化的效果；

    - 验证BiCGSTABSolver的正确性与性能，对比GMRES的收敛速度。

##### 技术要求

1. 性能：1e5 DOF实矩阵，CG+ILU(0)求解耗时＜100ms，迭代次数＜200；1e5 DOF复块稀疏矩阵，CGNR+BlockILU0求解耗时＜150ms；

2. 收敛优化：优化后迭代次数较阶段2减少≥30%，收敛速度提升≥30%；

3. 内存优化：1e5 DOF求解过程中，临时内存占用≤矩阵内存的2倍，无内存泄漏、碎片化；

4. 鲁棒性：大规模DOF（1e5）求解无崩溃，迭代过程中残差无异常波动；

5. 易用性：预处理参数、收敛准则可灵活配置，支持自动推荐最优组合。

##### 交付物

1. 新增/更新文件：`bicgstab_solver.h/cpp`，更新现有求解器、预处理、适配层文件（优化逻辑）；

2. 测试用例：`test_solver_serial_optimize.cpp`，扩展现有测试用例；

3. 文档更新：`solver_basic_api.md`（新增BiCGSTAB求解器、优化参数说明）、`solver_perf_optimize.md`（性能优化说明）；

4. 性能报告：`serial_solver_perf_report.md`（不同规模DOF、不同矩阵类型的性能测试结果）。

##### 验证标准

1. 性能达标：大规模DOF（1e5）求解耗时、迭代次数满足技术要求，性能较阶段2提升≥30%；

2. 收敛优化：收敛速度提升明显，迭代次数减少≥30%，无无效迭代；

3. 鲁棒性：大规模DOF求解无崩溃、无内存泄漏，残差无异常波动；

4. 易用性：参数配置灵活，自动推荐最优求解器+预处理组合，使用便捷。

---

#### 阶段4：分布式求解器基础（适配框架阶段4：分布式矩阵基础+MPI+OpenMP阶段2-3）

##### 阶段目标

实现**分布式求解器基础功能**，基于MPI封装层，实现分布式实/复矩阵求解器（分布式CG/GMRES）、分布式预处理（分布式ILU(0)），对接稀疏矩阵阶段4的分布式COO/CSR矩阵、DOF管理阶段4的分布式DOF分域，支持MPI多进程分布式求解，适配OpenMP多线程，实现分布式模式下的基础求解与数据同步，验证分布式求解的正确性与并行效率。

##### 核心开发任务（AI具体操作）

1. 分布式求解器架构搭建：

    - 实现分布式求解器统一基类`DistributedSolver`，继承`SolverBase`，对接MPI封装层；

    - 实现`DistributedCGSolver`、`DistributedGMRESSolver`类，继承`DistributedSolver`，支持实/复矩阵、普通稀疏/块稀疏矩阵；

    - 实现分布式求解核心逻辑：子域局部求解、进程间残差同步、解向量同步，遵循“每个进程求解子域局部矩阵，根进程汇总结果”的逻辑；

    - 无感适配：分布式求解器接口与串行求解器一致，用户无需修改代码，仅需配置并行模式。

2. 分布式预处理实现：

    - 实现`DistributedILU0Preconditioner`类，继承`PreconditionerBase`，支持分布式实/复矩阵、普通稀疏/块稀疏矩阵；

    - 分布式预处理逻辑：每个进程对自身子域的局部矩阵做ILU(0)预处理，通过MPI实现预处理矩阵的跨进程同步（仅界面DOF相关）；

    - 适配分布式稀疏矩阵：对接稀疏矩阵模块的分布式COO/CSR矩阵，读取子域局部矩阵数据，避免跨进程内存访问。

3. 分布式数据同步与通信优化：

    - 对接MPI封装层的集合通信接口（`broadcast`/`gather`/`scatter`），实现残差、解向量的跨进程同步；

    - 通信优化：采用非阻塞通信（isend/irecv）替代阻塞通信，减少进程等待时间；界面DOF数据批量同步，减少通信次数；

    - 数据拆分与合并：对接MPI封装层的`split_data()`接口，实现求解向量的分布式拆分（每个进程仅存储子域局部解向量）、根进程合并（生成全局解向量）。

4. OpenMP多线程适配（进程内并行）：

    - 扩展分布式求解器，支持进程内OpenMP多线程并行计算：残差计算、矩阵乘向量、预处理矩阵乘向量；

    - 对接OpenMP封装层的宏（`OMP_PARALLEL_FOR`），实现进程内线程负载均衡；

    - 验证混合模式（MPI+OpenMP）：MPI分进程，每个进程内用OpenMP多线程并行，确保进程间无线程竞争。

5. 分布式测试用例开发：

    - 编写`test_solver_distributed_basic.cpp`，基于MPI实现2/4/8进程测试，构造分布式实/复矩阵小算例（1e5 DOF），测试分布式求解器正确性；

    - 编写`test_solver_distributed_omp.cpp`，测试混合模式（MPI+OpenMP）的求解正确性与性能；

    - 测试分布式数据同步：验证各进程残差、解向量同步的正确性，根进程合并结果与串行求解结果一致；

    - 对接计时工具阶段3，统计各进程求解耗时、通信耗时，验证并行效率。

##### 技术要求

1. 正确性：分布式求解结果（根进程合并后）与串行求解结果一致，残差收敛到设定精度；

2. 并行效率：4进程分布式求解（1e5 DOF）耗时较串行降低≥70%；混合模式（4进程×4线程）耗时较纯MPI（4进程）降低≥30%；

3. 通信优化：通信耗时占总求解耗时的比例＜20%，无冗余通信；

4. 协同性：与MPI+OpenMP封装层、分布式稀疏矩阵、分布式DOF管理无缝对接，无耦合、无冲突；

5. 无感适配：分布式/串行模式可通过编译宏/配置文件切换，无需修改业务代码；

6. 鲁棒性：多进程（≥8）求解无崩溃、无死锁，数据同步无错乱，进程异常退出时能正确捕获。

##### 交付物

1. 新增/更新文件：`distributed_solver.h/cpp`、`distributed_ilu0_preconditioner.h/cpp`，更新现有求解器、适配层文件；

2. 测试用例：`test_solver_distributed_basic.cpp`、`test_solver_distributed_omp.cpp`；

3. 文档更新：`solver_distributed_api.md`（分布式求解器接口、并行模式配置说明）；

4. 适配文件：更新适配层文件（对接分布式矩阵、MPI+OpenMP、分布式DOF）；

5. 性能报告：`distributed_solver_perf_report.md`（不同进程数/线程数的性能测试结果）。

##### 验证标准

1. 功能正确性：分布式求解结果与串行一致，数据同步无错乱，残差收敛符合预期；

2. 并行效率：并行耗时、通信耗时满足技术要求，并行效率达标；

3. 协同性：与现有分布式模块对接顺畅，无编译/运行错误；

4. 无感适配：并行模式切换无需修改代码，运行正常；

5. 鲁棒性：多进程求解无崩溃、无死锁，异常场景处理正确。

---

#### 阶段5：FETI-DP专用求解器（适配框架阶段5：FETI-DP核心+MPI+OpenMP阶段4）

##### 阶段目标

实现**FETI-DP专用求解器**，对接稀疏矩阵阶段5的子域刚度矩阵Kᵢ、界面约束矩阵Bᵢ、耦合矩阵F，适配DOF管理阶段5的界面DOF提取、主从标记，实现FETI-DP框架下的分布式求解，支持MPI+OpenMP混合编程，支撑低频电磁大规模DOF（1e6级）的FETI-DP求解，验证求解正确性与性能。

##### 核心开发任务（AI具体操作）

1. FETI-DP求解器核心实现：

    - 封装`FETIDPSolver`类，继承`DistributedSolver`，专门适配FETI-DP框架；

    - 实现FETI-DP核心求解流程：

        1. 子域求解：每个进程求解子域局部刚度矩阵Kᵢ的Schur补；

        2. 界面约束应用：对接界面DOF提取模块的`InterfaceDofExtractor`，获取界面DOF主从标记、邻接关系，应用界面约束矩阵Bᵢ；

        3. 耦合计算：基于耦合矩阵F，实现子域界面DOF的耦合求解，通过MPI实现跨进程界面数据同步；

        4. 全局校正：根进程汇总各子域求解结果，做全局校正，更新解向量；

        5. 迭代收敛：重复上述步骤，直到残差收敛到设定精度。

    - 适配FETI-DP矩阵：支持子域刚度矩阵Kᵢ、界面约束矩阵Bᵢ、耦合矩阵F的分布式存储与求解，对接稀疏矩阵阶段5的FETI-DP矩阵模块。

2. 界面通信与同步优化：

    - 对接界面DOF提取模块，获取界面DOF的子域归属、主从标记，仅在界面DOF处做MPI通信；

    - 通信优化：界面DOF数据批量同步，采用非阻塞通信，减少通信量；主从子域通信优先，避免死锁；

    - 界面残差同步：优化界面残差的计算与同步逻辑，确保各进程界面残差一致，提升求解正确性。

3. Schur补分解实现（FETI-DP核心）：

    - 实现子域刚度矩阵Kᵢ的Schur补分解，拆分内部DOF与界面DOF对应的子矩阵；

    - 优化Schur补计算：进程内用OpenMP多线程并行计算Schur补，提升计算速度；

    - 对接预处理层：实现Schur补矩阵的分布式ILU(0)预处理，提升FETI-DP求解的收敛速度。

4. 混合模式（MPI+OpenMP）深度适配：

    - MPI分进程：每个进程对应一个子域，负责子域局部求解、界面通信；

    - OpenMP多线程：每个进程内用OpenMP多线程并行计算Schur补、子域求解、残差计算；

    - 负载均衡：基于子域DOF规模、计算量，动态调整每个进程的线程数，确保负载均衡。

5. FETI-DP测试用例开发：

    - 编写`test_solver_fetidp.cpp`，构造FETI-DP子域分域小算例（2/4子域，1e5~1e6 DOF），测试FETI-DP求解器的正确性；

    - 测试界面约束应用、Schur补分解、耦合计算的正确性，验证求解结果与理论一致；

    - 测试混合模式（MPI+OpenMP）的性能，验证大规模DOF（1e6）的求解效率；

    - 对接计时工具阶段4，统计FETI-DP各阶段耗时（子域求解、界面通信、耦合计算、全局校正）。

##### 技术要求

1. 正确性：FETI-DP求解结果与串行/分布式普通求解器结果一致，界面约束满足，主从标记应用正确；

2. 性能：1e6 DOF，4进程×8线程混合模式，FETI-DP求解耗时＜10s，迭代次数＜500；

3. 通信优化：界面通信耗时占总求解耗时的比例＜10%，无冗余通信；

4. Schur补分解：分解正确，计算效率高，4线程并行计算耗时较单线程降低≥60%；

5. 协同性：与FETI-DP矩阵模块、界面DOF提取模块、MPI+OpenMP封装层无缝对接，无耦合、无冲突；

6. 鲁棒性：多子域（≥8）、大规模DOF（1e6）求解无崩溃、无死锁，界面数据同步无错乱。

##### 交付物

1. 新增/更新文件：`fetidp_solver.h/cpp`、`schur_complement.h/cpp`，更新分布式求解器、适配层文件；

2. 测试用例：`test_solver_fetidp.cpp`；

3. 文档更新：`solver_fetidp_api.md`（FETI-DP求解器接口、使用说明、参数配置）；

4. 适配文件：更新适配层文件（对接界面DOF提取、FETI-DP矩阵）；

5. 性能报告：`fetidp_solver_perf_report.md`（不同子域数、线程数的性能测试结果）。

##### 验证标准

1. 功能正确性：FETI-DP求解结果正确，界面约束、主从标记应用正确，Schur补分解无误；

2. 性能达标：大规模DOF求解耗时、迭代次数、通信耗时满足技术要求；

3. 协同性：与现有FETI-DP相关模块对接顺畅，无编译/运行错误；

4. 鲁棒性：多子域、大规模DOF求解无崩溃、无死锁，异常场景处理正确；

5. 负载均衡：MPI进程、OpenMP线程负载均匀，无明显空闲。

---

#### 阶段6：模块集成、测试与第三方求解器适配（可选，适配框架阶段6：全流程集成测试）

##### 阶段目标

完成求解模块与框架全流程集成测试，优化模块性能与鲁棒性，**实现第三方求解器（superlu、mumps等）适配接入**，验证第三方求解器与自研求解器的无感切换、数据兼容性、并行协同性，确保模块满足工程化落地要求，同时完善文档与测试用例。

##### 核心开发任务（AI具体操作）

1. 模块全流程集成测试：
                  对接框架各模块（DOF管理、稀疏矩阵、MPI+OpenMP、计时/内存管理），完成全流程联调，排查模块间协同冲突；

2. 编写集成测试用例，覆盖低频电磁全场景（静电/静磁/涡流）、所有并行模式、所有求解器+预处理组合，验证模块稳定性；

3. 性能压测：针对千万级DOF大规模算例，测试混合模式（4进程×8线程）求解性能，优化性能瓶颈（如通信、计算逻辑）。

4. 第三方求解器适配接入（核心）：
                  基于`ThirdPartySolverAdapter`基类，分别实现superlu、mumps求解器的适配类（`SuperLUSolverAdapter`、`MumpsSolverAdapter`）；

5. 实现数据格式适配：适配层新增矩阵格式转换接口，支持自研COO/CSR/块稀疏矩阵与superlu、mumps支持格式的双向转换，复用内存，减少拷贝；

6. 实现参数与接口适配：制定参数映射规则，将自研求解器参数（迭代次数、收敛精度等）转换为第三方求解器兼容参数，实现统一接口调用；

7. 并行模式适配：复用现有MPI+OpenMP封装层，适配第三方求解器的并行逻辑（如mumps分布式求解、superlu多线程求解），确保并行模式无感切换；

8. 验证适配正确性：编写第三方求解器测试用例，对比第三方求解器与自研求解器的求解结果、性能，验证数据兼容性与求解正确性。

9. 模块优化与完善：
                  针对集成测试、性能压测中发现的问题，优化核心逻辑（如通信效率、内存占用、收敛速度）；

10. 完善异常处理：新增第三方求解器接入相关异常（如适配失败、求解异常），抛出明确错误信息，方便调试；

11. 完善配置化：JSON配置文件新增第三方求解器选择、参数配置选项，支持用户灵活选择自研/第三方求解器。

12. 文档与测试用例完善：
                  更新所有文档，新增第三方求解器接入指南、适配规范、接口说明、参数配置说明；

13. 完善测试用例，新增第三方求解器相关测试用例（正确性、性能、并行协同），确保测试覆盖率≥95%；

14. 编写用户手册，明确第三方求解器的接入步骤、调用方式、常见问题排查方法。

##### 技术要求

1. 集成兼容性：求解模块与框架各模块协同无冲突，全流程求解无编译/运行错误，代码覆盖率≥95%；

2. 第三方适配要求：superlu、mumps求解器接入后，与自研求解器接口统一，无感切换；求解结果误差≤1e-6，性能不低于自研求解器对应场景；

3. 并行适配：第三方求解器支持的并行模式（串行/OpenMP/MPI/混合）与现有框架完全适配，无需额外配置；

4. 鲁棒性：第三方求解器适配过程中，能正确捕获适配失败、求解异常等场景，无崩溃、无数据错乱；

5. 易用性：用户可通过配置文件/API接口一键切换自研/第三方求解器，无需修改业务代码。

##### 交付物

1. 新增/更新文件：`third_party_solver_adapter.h/cpp`、`superlu_solver_adapter.h/cpp`、`mumps_solver_adapter.h/cpp`，更新适配层、配置层相关文件；

2. 测试用例：集成测试用例、第三方求解器测试用例，完善现有测试用例集；

3. 文档更新：所有API手册、使用手册、适配指南，新增《第三方求解器接入指南》《第三方求解器适配规范》；

4. 配置文件：更新JSON配置文件模板，新增第三方求解器配置选项；

5. 最终性能报告：全场景性能压测报告、第三方求解器与自研求解器性能对比报告。

##### 验证标准

1. 集成测试：全流程求解正确，无协同冲突，性能压测满足千万级DOF求解要求；

2. 第三方适配：superlu、mumps求解器接入成功，接口统一，无感切换，求解结果、性能达标；

3. 鲁棒性：异常场景无崩溃，异常信息清晰，第三方求解器求解过程稳定；

4. 易用性：配置、调用便捷，用户无需关注底层适配细节，文档完善，可快速接入使用。
> （注：文档部分内容可能由 AI 生成）