# 自由度（DOF）管理工具AI开发计划（适配低频电磁有限元+串行/FETI-DP统一框架）

## 一、开发整体目标

AI需按本计划逐步实现**自由度（DOF）管理工具**，核心支撑稀疏矩阵模块（串行+FETI-DP分布式）的全流程开发，完成「DOF编号管理、DOF集操作、界面DOF提取」三大核心功能，实现与内存管理工具、稀疏矩阵模块、分布式MPI模块的无缝协同，最终达到：

1. 功能适配：原生支持低频电磁场景（标量元-节点DOF、矢量元-边DOF），兼容静电/静磁/涡流场，支撑稀疏矩阵组装、子域拆分、FETI-DP界面耦合；

2. 性能达标：大规模DOF（百万/千万级）下，编号映射、集操作、界面提取效率满足稀疏矩阵求解需求，缓存命中率、内存复用率符合协同要求；

3. 架构兼容：遵循「串行=1进程分布式」统一设计，无代码冗余，可直接集成到有限元框架；

4. 工程化可用：提供简洁API、完整测试用例、清晰文档，模块化设计，可单独编译、维护、扩展。

## 二、技术栈与协同约定（AI严格遵循）

### 1. 核心技术栈

- 编程语言：C++17（必须兼容，兼顾现代特性与性能）；

- 容器与内存：基于C++ STL，核心数组/容器需通过**内存管理工具**（DynamicArrayPreallocator、CacheLineAligner）管理，禁止裸指针直接分配内存；

- 模板与枚举：使用模板类适配不同DOF类型（NODE/EDGE），枚举类严格遵循设计方案中的`DofType`、`DofAttr`定义；

- 依赖模块：与稀疏矩阵模块、内存管理工具、MPI通信模块（分布式阶段）深度协同，不依赖第三方拓扑/DOF管理库；

- 编码规范：类名`UpperCamelCase`、函数/变量名`lower_snake_case`，注释清晰（关键函数、核心逻辑需加详细注释），代码无冗余、无内存泄漏。

### 2. 模块协同要求

- 与内存管理工具：所有DOF相关数组（映射表、DOF集位图等）需使用`DynamicArrayPreallocator`预分配容量，通过`CacheLineAligner`实现64字节缓存行对齐，复用内存管理接口；

- 与稀疏矩阵模块：API设计需适配稀疏矩阵组装（DOF索引直接赋值）、子矩阵提取（DOF集有序输出）、FETI-DP界面矩阵生成（界面DOF拓扑信息）；

- 与分布式MPI模块：分布式阶段需通过`MPICommWrapper`实现DOF信息同步、界面DOF通信，确保多进程DOF编号、拓扑信息一致；

- 与网格模块：通过`mesh_topo_interface.h`接口获取网格拓扑信息，不侵入网格模块核心逻辑，实现拓扑解耦。

## 三、分阶段开发计划（与稀疏矩阵模块6阶段同步，一一对应）

### 阶段1：基础DOF编号管理（适配稀疏矩阵阶段1：基础COO/CSR）

#### 阶段目标（AI需达成）

完成DOF管理工具的基础搭建，实现**串行场景下的核心DOF编号功能**，适配稀疏矩阵阶段1的COO/CSR矩阵组装，完成与内存管理工具的基础协同。

#### 核心开发任务（AI具体操作）

1. 基础枚举与接口定义：

    - 实现`dof_type.h`，定义`DofType`（NODE/EDGE，暂不实现FACE）、`DofAttr`（NONE/DIRICHLET/NEUMANN，暂不实现INTERFACE/PERIODIC）枚举类；

    - 实现`mesh_topo_interface.h`，定义网格拓扑基础接口（获取单元数量、单元关联的节点/边索引），无需实现具体网格交互，仅提供接口声明。

2. DofNumberer基础实现（模板类，适配NODE/EDGE）：

    - 实现`dof_numberer.h/cpp`，定义`DofNumberer<DoFType>`模板类，核心成员变量（elem2global_map_、dof_attr_等）使用内存管理工具的`DynamicArrayPreallocator`管理；

    - 实现核心接口：`global_dof_size()`、`elem2global()`（单元局部→全局DOF映射）、`set_dof_attr()`、`get_dof_attr()`；

    - 实现DOF自动编号生成逻辑：输入网格拓扑接口、单元类型，遍历节点/边，生成无冲突的全局DOF编号，填充`elem2global_map_`。

3. 与内存管理工具协同：

    - 所有核心数组（elem2global_map_、dof_attr_）通过`DynamicArrayPreallocator`预分配容量（按网格单元数量、单元DOF数计算预分配大小）；

    - 通过`CacheLineAligner`实现数组缓存行对齐，调用`aligned_alloc`接口分配内存，确保索引查表高效。

4. 基础测试用例开发：

    - 编写`test_dof_numberer.cpp`，构造简单网格（3×3节点、4个四面体单元），测试NODE/EDGE DOF的自动编号、`elem2global()`映射正确性；

    - 测试内存协同效果：验证数组预分配容量合理性、缓存行对齐正确性（调用`is_aligned`接口）。

#### 技术要求（AI必须满足）

1. DOF编号规则：全局DOF从0开始连续编号，无重复、无越界，单元局部DOF与单元类型匹配（四面体标量元4个节点→03，矢量元6条边→05）；

2. 内存协同：核心数组预分配无冗余（容量误差≤10%），缓存行对齐校验通过，无未对齐内存；

3. 效率：单元局部→全局映射（elem2global）时间复杂度O(1)，1e4个单元的DOF编号生成耗时≤1ms；

4. 鲁棒性：输入无效单元ID、单元局部DOF编号，抛出明确异常（如std::out_of_range），附带错误信息。

#### 交付物（AI需提交）

1. 头文件：`dof_type.h`、`mesh_topo_interface.h`、`dof_numberer.h`；

2. 源文件：`dof_numberer.cpp`；

3. 测试用例：`test_dof_numberer.cpp`；

4. 临时文档：`dof_numberer_api说明.md`（简单说明核心接口用法，供稀疏矩阵模块调用）。

#### 测试验证标准（AI自行验证，确保达标）

1. 功能正确性：NODE/EDGE DOF编号无重复、无越界，`elem2global()`映射结果与理论值完全一致；

2. 内存协同：数组预分配容量合理，缓存行对齐校验通过，无内存泄漏；

3. 边界测试：空网格、单个单元网格的DOF编号生成无崩溃，异常输入能正确抛出。

### 阶段2：DOF集基础操作与边界DOF处理（适配稀疏矩阵阶段2：串行矩阵操作）

#### 阶段目标（AI需达成）

完善DOF编号管理的边界处理功能，实现基础DOF集操作，支撑稀疏矩阵阶段2的子矩阵提取、预处理（边界DOF批量修改），优化内存协同效率。

#### 核心开发任务（AI具体操作）

1. DofNumberer功能完善：

    - 新增`reorder()`接口，实现Cuthill-McKee（CMK）重排序算法，重排序后自动更新`elem2global_map_`，支撑稀疏矩阵带宽优化；

    - 完善边界DOF处理：新增`get_dirichlet_dofs()`接口，批量获取所有Dirichlet边界DOF的全局编号，适配稀疏矩阵预处理时的边界修改。

2. 基础DofSet类实现：

    - 实现`dof_set.h/cpp`，定义`DofSet`类，底层容器根据DOF规模自动选择（小规模用unordered_set，大规模用BitMask）；

    - 实现核心接口：insert()、erase()、contains()、to_sorted_vector()（有序输出DOF数组，适配稀疏矩阵索引有序性）、size()、empty()；

    - 新增批量插入接口`insert_range()`，支持一次性插入多个DOF，避免循环单插入开销。

3. 内存协同优化：

    - 优化`DofSet`的内存管理：BitMask底层数组使用`DynamicArrayPreallocator`预分配，实现缓存行对齐；

    - 新增`DofNumberer`的`reset()`接口，支持DOF映射表内存复用，适配稀疏矩阵多轮组装场景。

4. 测试用例扩展：

    - 扩展`test_dof_numberer.cpp`，测试CMK重排序的正确性、边界DOF批量查询功能；

    - 编写`test_dof_set.cpp`，测试DOF集的插入、删除、筛选、有序输出功能，验证大规模DOF集（1e5个）的操作效率。

#### 技术要求（AI必须满足）

1. 重排序：CMK重排序后，DOF映射表无错乱，稀疏矩阵带宽比未排序时降低≥30%；

2. DOF集操作：1e5个DOF的批量插入耗时≤2ms，to_sorted_vector()输出数组严格升序；

3. 内存：大规模DOF集（1e5个）的BitMask内存占用≤13MB（1个bit对应1个DOF），无内存碎片化；

4. 协同性：DofSet的to_sorted_vector()输出可直接作为稀疏矩阵子矩阵提取的索引，无需二次处理。

#### 交付物（AI需提交）

1. 新增/更新文件：`dof_set.h`、`dof_set.cpp`，更新`dof_numberer.h/cpp`；

2. 测试用例：`test_dof_set.cpp`，扩展`test_dof_numberer.cpp`；

3. 文档更新：更新`dof_numberer_api说明.md`，新增DofSet接口说明。

#### 测试验证标准（AI自行验证，确保达标）

1. 功能正确性：重排序后DOF映射正确，边界DOF批量查询无遗漏；DOF集操作无错误，有序输出符合要求；

2. 效率：大规模DOF集操作效率达标，重排序耗时≤5ms（1e5个DOF）；

3. 协同性：DofSet输出的有序数组可直接用于稀疏矩阵子矩阵提取，与COO/CSR矩阵衔接无异常。

### 阶段3：电磁场景深度适配（适配稀疏矩阵阶段3：低频电磁场景适配）

#### 阶段目标（AI需达成）

完成DOF管理工具的电磁场景定制，适配稀疏矩阵阶段3的块稀疏矩阵、复矩阵，支持矢量元边DOF、周期性边界DOF，完善DOF集的电磁定制功能。

#### 核心开发任务（AI具体操作）

1. 电磁场景DOF适配：

    - 更新`dof_type.h`，扩展`DofAttr`枚举，新增`PERIODIC`（周期性边界）属性；

    - 完善`DofNumberer`的电磁适配：新增复DOF标记（is_complex_成员），实现`set_complex_dof()`、`is_complex_dof()`接口，适配涡流场复矩阵；

    - 新增周期性DOF映射：实现`set_periodic_dof_pair()`、`get_periodic_dof_pair()`接口，建立周期性边界的DOF对映射，支撑稀疏矩阵周期性约束组装。

2. DofSet电磁定制功能：

    - 扩展`DofSet`，新增`filter_by_attr()`、`filter_by_complex()`接口，支持按DOF属性（Dirichlet/Neumann/PERIODIC）、复DOF类型筛选；

    - 新增`get_periodic_dof_pairs()`接口，批量获取周期性DOF对，适配稀疏矩阵周期性约束的批量处理。

3. 矢量元边DOF优化：

    - 优化`DofNumberer<DoFType::EDGE>`的编号逻辑，基于网格边的拓扑关系，避免边DOF编号重复（适配四面体/六面体矢量元）；

    - 新增`get_edge_dof_adjacency()`接口，获取边DOF的邻接关系，支撑稀疏矩阵块稀疏（矢量元2×2/3×3块）的索引生成。

4. 电磁场景测试用例：

    - 编写`test_dof_em_adapter.cpp`，构造静磁场（边DOF）、涡流场（复边DOF）测试场景，验证周期性DOF映射、复DOF标记、边DOF邻接关系的正确性；

    - 扩展`test_dof_set.cpp`，测试电磁定制筛选功能，验证筛选结果与理论边界DOF、复DOF一致。

#### 技术要求（AI必须满足）

1. 电磁适配：矢量元边DOF编号无重复，周期性DOF映射准确，复DOF标记与稀疏矩阵复数据存储衔接无异常；

2. 边DOF邻接：邻接关系与网格拓扑一致，能直接用于块稀疏矩阵的块索引生成；

3. 筛选效率：1e5个DOF的电磁定制筛选耗时≤3ms，周期性DOF对批量查询耗时≤1ms；

4. 兼容性：与稀疏矩阵的块稀疏、复矩阵模块衔接顺畅，API调用无冲突。

#### 交付物（AI需提交）

1. 新增/更新文件：更新`dof_type.h`、`dof_numberer.h/cpp`、`dof_set.h/cpp`；

2. 测试用例：`test_dof_em_adapter.cpp`，扩展`test_dof_set.cpp`；

3. 文档：新增`dof_em_adapter说明.md`，说明电磁场景下的API用法、适配细节。

#### 测试验证标准（AI自行验证，确保达标）

1. 电磁适配：矢量元边DOF编号正确，周期性DOF映射无错乱，复DOF标记准确；

2. 功能正确性：电磁定制筛选能准确获取边界DOF、复DOF，边DOF邻接关系与网格拓扑一致；

3. 协同性：能直接支撑稀疏矩阵块稀疏的块索引生成、复矩阵的DOF标记，无衔接异常。

### 阶段4：分布式DOF编号与DOF集适配（适配稀疏矩阵阶段4：分布式矩阵基础）

#### 阶段目标（AI需达成）

实现分布式场景下的DOF编号管理与DOF集操作，支撑稀疏矩阵阶段4的分布式向量/矩阵（DistributedVector/DistributedSparseMatrix），确保多进程DOF信息一致。

#### 核心开发任务（AI具体操作）

1. DofNumberer分布式扩展：

    - 扩展`DofNumberer`类，新增三层DOF映射：单元局部→全局、子域局部→全局、全局→子域局部，新增`local2global()`、`global2local()`接口；

    - 新增`local_dof_size()`接口，获取当前子域的局部DOF规模，1进程时局部DOF等价于全局DOF（无代码冗余）；

    - 实现分布式DOF编号同步：通过`MPICommWrapper`，由根进程生成全局DOF编号，广播到所有进程，各进程根据子域拆分信息生成局部DOF映射表。

2. DofSet分布式适配：

    - 扩展`DofSet`类，新增`to_local_dof()`接口，将全局DOF集转换为当前子域的局部DOF集，自动过滤无效DOF；

    - 新增`is_global_dof_in_subdomain()`接口，检测全局DOF是否属于当前子域，避免分布式操作时的越界；

    - 优化DofSet的分布式内存管理：多进程DOF集的底层容器预分配容量一致，避免通信时的数据错乱。

3. 分布式协同与通信：

    - 实现`DofNumberer`的`broadcast_dof_info()`接口，通过MPI广播全局DOF规模、局部DOF映射表，确保所有进程信息一致；

    - 适配分布式MPI模块，`DofSet`的通信接口与MPI非阻塞通信（Isend/Irecv）协同，仅传输界面相关DOF数据。

4. 分布式测试用例：

    - 扩展`test_dof_numberer.cpp`、`test_dof_set.cpp`，新增MPI多进程测试（2/4进程），验证分布式DOF映射、信息同步的正确性；

    - 测试1进程（串行）与多进程（分布式）的DOF管理行为一致性，确保无差异。

#### 技术要求（AI必须满足）

1. 分布式一致性：所有进程的全局DOF规模、DOF映射表、边界DOF信息完全一致，无冲突；

2. 映射正确性：局部→全局、全局→局部映射无错乱，跨进程DOF索引转换正确；

3. 通信效率：DOF信息广播耗时≤1ms（1e5个DOF），DOF集通信仅传输有效数据，无冗余；

4. 兼容性：1进程时，分布式DOF管理自动退化为主串行模式，无需额外代码分支，与稀疏矩阵的分布式适配无冲突。

#### 交付物（AI需提交）

1. 更新文件：`dof_numberer.h/cpp`、`dof_set.h/cpp`，新增分布式相关接口；

2. 测试用例：扩展现有测试用例，新增多进程测试逻辑；

3. 文档：新增`dof_distributed_adapter说明.md`，说明分布式DOF管理的API用法、通信逻辑。

#### 测试验证标准（AI自行验证，确保达标）

1. 一致性：多进程下，全局DOF规模、DOF映射、边界DOF信息一致，无差异；

2. 正确性：分布式DOF映射无错乱，DOF集转换（全局→局部）无无效值；

3. 兼容性：1进程与多进程行为一致，与稀疏矩阵的分布式向量/矩阵衔接顺畅。

### 阶段5：界面DOF提取与FETI-DP适配（适配稀疏矩阵阶段5：FETI-DP核心）

#### 阶段目标（AI需达成）

实现界面DOF提取全功能，生成FETI-DP所需的界面DOF信息、拓扑邻接关系，支撑稀疏矩阵阶段5的界面约束矩阵Bᵢ、耦合矩阵F的组装，完成与FETI-DP模块的协同。

#### 核心开发任务（AI具体操作）

1. 界面DOF提取类实现：

    - 实现`interface_dof_extractor.h/cpp`，定义`InterfaceDofExtractor`类、`InterfaceDofInfo`结构体（全局DOF、子域归属、界面类型等）；

    - 实现核心提取逻辑：extract_node_interface_dofs()（标量元-节点DOF提取）、extract_edge_interface_dofs()（矢量元-边DOF提取，电磁核心）；

    - 新增周期性界面DOF提取：实现`extract_periodic_interface_dofs()`接口，提取周期性边界的界面DOF，标记其属性。

2. 界面DOF拓扑与主从标记：

    - 实现`mark_master_slave_subdomain()`接口，按子域ID规则标记界面DOF的主/从子域，确保多进程标记一致；

    - 实现`get_interface_adjacency()`接口，构建界面DOF的邻接关系（基于网格拓扑），直接提供块稀疏矩阵的块索引。

3. FETI-DP协同适配：

    - 新增`get_interface_dof_set()`（按子域获取界面DOF集）、`get_global_interface_dof_set()`（全局界面DOF集）接口，直接供稀疏矩阵提取界面子矩阵；

    - 实现界面DOF信息的序列化/反序列化接口，支持写入文件，方便FETI-DP迭代的结果复现与调试。

4. 集成测试与优化：

    - 编写`test_interface_dof.cpp`，测试界面DOF提取的正确性（与网格拓扑一致）、主从标记一致性、邻接关系准确性；

    - 与稀疏矩阵阶段5的FETI-DP矩阵模块协同测试，验证界面DOF信息能直接支撑Bᵢ、F矩阵的组装；

    - 优化界面提取效率，减少拓扑遍历开销，适配大规模网格（1e5个面）的界面提取。

#### 技术要求（AI必须满足）

1. 界面提取正确性：界面DOF的归属子域、类型、邻接关系与网格拓扑完全一致，无遗漏、无错误（矢量元边DOF重点验证）；

2. 分布式一致性：多进程下，界面DOF的主从标记、邻接关系完全一致，无冲突；

3. 效率：1e5个网格面的界面DOF提取耗时≤10ms，界面邻接关系构建耗时≤5ms；

4. FETI-DP适配：界面DOF集、邻接关系可直接用于Bᵢ矩阵组装，无需稀疏矩阵模块额外处理拓扑。

#### 交付物（AI需提交）

1. 新增文件：`interface_dof_extractor.h`、`interface_dof_extractor.cpp`；

2. 测试用例：`test_interface_dof.cpp`，扩展现有测试用例的协同逻辑；

3. 文档：新增`interface_dof_extractor说明.md`，说明界面提取逻辑、API用法、与FETI-DP的协同方式。

#### 测试验证标准（AI自行验证，确保达标）

1. 提取正确性：界面DOF无遗漏、无错误，主从标记一致，邻接关系与网格拓扑匹配；

2. 协同性：界面DOF信息可直接支撑Bᵢ、F矩阵组装，与FETI-DP模块衔接无异常；

3. 效率：大规模网格的界面提取效率达标，无性能瓶颈；

4. 鲁棒性：跨子域网格面、周期性界面的提取无崩溃，异常拓扑（如孤立面）能正确处理。

### 阶段6：工程化集成、优化与文档完善（适配稀疏矩阵阶段6：集成与工程化）

#### 阶段目标（AI需达成）

完成DOF管理工具的工程化封装、性能优化、文档完善，与有限元框架、稀疏矩阵模块完全集成，实现自动化DOF管理，达到可实际使用标准。

#### 核心开发任务（AI具体操作）

1. 工程化封装：

    - 新增`dof_manager.h`汇总头文件，一键引入所有DOF管理相关头文件，简化稀疏矩阵模块的调用；

    - 实现DOF管理工具的单例封装（可选），避免多实例重复创建，节省内存；

    - 优化API接口，简化调用逻辑，新增高层封装接口（如`init_dof_manager()`），实现DOF管理的自动化初始化。

2. 性能优化：

    - 优化DOF编号的拓扑遍历逻辑，减少网格拓扑查询开销，大规模DOF（1e6个）的编号生成耗时≤20ms；

    - 优化DofSet的BitMask实现，提升大规模DOF集的按位操作效率（并、交、差）；

    - 优化界面DOF提取算法，避免重复遍历网格面，提升大规模网格的提取效率。

3. 工程化补充：

    - 集成日志系统（适配spdlog），新增DOF管理相关日志（初始化、操作、错误信息），方便调试；

    - 实现Python绑定（使用pybind11），封装核心API，支持Python脚本调用测试；

    - 支持JSON配置文件解析，可通过配置指定DOF类型、重排序算法、界面提取参数。

4. 全流程集成测试与文档完善：

    - 编写`test_dof_full_integration.cpp`，实现DOF管理工具与稀疏矩阵模块、内存管理工具、MPI模块的全流程集成测试，跑通电磁标准算例（平行板电容、螺线管电感）；

    - 完善所有文档，编写`DOF管理工具使用手册.md`，包含API详解、开发背景、适配场景、常见问题；

    - 整理代码注释，确保关键逻辑、接口、变量有清晰注释，代码可维护性达标。

#### 技术要求（AI必须满足）

1. 工程化：API调用简洁，集成便捷，日志输出清晰，Python绑定可正常调用所有核心功能；

2. 性能：大规模DOF（1e6个）下，编号生成、界面提取、DOF集操作效率达标，无性能瓶颈；

3. 集成性：与有限元框架、稀疏矩阵模块完全集成，可支撑电磁标准算例的全流程求解；

4. 可维护性：代码模块化、无耦合，注释完整，文档详细，后续可轻松扩展（如新增FACE DOF）。

#### 交付物（AI需提交）

1. 新增/更新文件：`dof_manager.h`、`dof_python_bind.cpp`，更新所有现有头文件/源文件（优化+注释）；

2. 测试用例：`test_dof_full_integration.cpp`，完善所有测试用例，确保覆盖率≥90%；

3. 文档：`DOF管理工具使用手册.md`、所有模块的API说明.md，整理代码注释；

4. 配置文件：`dof_config.json`，支持DOF管理参数配置。

#### 测试验证标准（AI自行验证，确保达标）

1. 集成性：可支撑电磁标准算例的全流程求解，DOF管理无异常，与稀疏矩阵、内存管理、MPI模块协同顺畅；

2. 性能：大规模DOF场景下，所有操作效率达标，无卡顿、无内存泄漏；

3. 工程化：Python绑定可正常调用，日志输出清晰，配置文件可正确解析；

4. 完整性：测试覆盖率≥90%，所有功能无bug，文档详细，代码可维护。

## 四、AI开发注意事项（必看）

1. 迭代开发：严格按6个阶段逐步执行，**前一阶段测试达标后，再启动下一阶段**，禁止超前开发，避免功能错乱；

2. 模块化与解耦：每个类/接口独立封装，不侵入网格、稀疏矩阵、MPI模块的核心逻辑，仅通过接口协同，避免代码耦合；

3. 测试驱动：每个功能实现后，立即编写对应测试用例，确保功能正确性，不堆积bug，测试用例需覆盖正常场景、边界场景、异常场景；

4. 电磁适配优先：所有功能优先适配低频电磁场景（节点/边DOF、静电/静磁/涡流），无需过早实现非核心功能（如FACE DOF、多物理场耦合）；

5. 分布式一致性：分布式阶段需重点关注多进程信息同步，确保DOF编号、界面标记、拓扑关系完全一致，避免跨进程耦合错误；

6. 内存协同：所有核心数组、容器必须通过内存管理工具管理，严格遵循预分配、缓存行对齐要求，禁止裸指针分配内存，避免内存泄漏、碎片化；

7. 编码规范：严格遵循约定的编码规范，类名、函数名、变量名统一格式，注释清晰，代码简洁，无冗余、无重复逻辑。

## 五、后续扩展方向（阶段6完成后，可选实现）

1. 新增FACE DOF支持，适配高频电磁或弹性力学场景；

2. 扩展多物理场DOF耦合接口，支持电磁-热、电磁-结构的DOF编号管理；

3. 集成更高效的DOF重排序算法（如METIS），进一步优化稀疏矩阵带宽；

4. 新增DOF可视化接口，支持将DOF编号、界面DOF、边界DOF导出到VTK文件，方便可视化调试。
> （注：文档部分内容可能由 AI 生成）