# 低频频域电磁稀疏矩阵全维度设计

作为低频电磁有限元求解器开发小白，对标Maxwell设计稀疏矩阵功能，需围绕**电磁矩阵特性、求解效率、场景适配、易用性**四大核心，从基础到进阶做全维度考量。以下是结构化头脑风暴，覆盖设计关键因素：

### 一、基础层：矩阵存储与核心结构设计

#### 1. 稀疏格式选型（适配电磁矩阵特性）

- 基础格式：优先支持 **CSR（压缩行存储）**（求解器通用）、**COO（坐标存储）**（有限元单元矩阵组装高效）、**CSC（压缩列存储）**（直接法列主元求解适配）。

- 电磁专用格式：

    - 对称压缩：静电/静磁矩阵多对称，仅存上/下三角，内存减半；

    - 块稀疏：适配Nedelec矢量元（边元），按单元块（如2x2、3x3）存储，提升矩阵-向量乘效率；

    - 动态格式：组装用COO，求解自动转CSR/CSC，兼顾组装与求解性能。

- 格式兼容：支持格式一键转换，适配不同求解阶段（组装→求解→后处理）。

#### 2. 全局索引与DOF映射

- 索引体系：区分**节点DOF**（标量元，静电）、**边DOF**（矢量元，静磁/涡流）、**面DOF**（低频电磁少用，可预留），建立“网格实体→全局DOF”映射表。

- 索引优化：支持**DOF重排序**（如Cuthill-McKee、AMD），减少矩阵带宽，提升缓存命中率与求解速度（对标Maxwell的自动重排序功能）。

- 边界条件索引处理：Dirichlet边界自动标记DOF，矩阵行/列置零、对角置1，避免手动修改索引。

#### 3. 矩阵属性封装（贴合低频电磁场景）

- 核心属性标记：对称/非对称、正定/半正定/不定、实/复（频域涡流为复矩阵）、奇异/非奇异（无约束静磁矩阵奇异，需预处理）。

- 电磁场景标签：绑定物理场类型（静电/静磁/涡流/瞬态），自动适配后续求解/预处理逻辑（如静磁自动启用散度约束预处理）。

### 二、核心层：矩阵组装与操作设计

#### 1. 高效单元矩阵组装

- 贡献累加：支持**单元矩阵→全局矩阵**的批量累加，避免单元素操作（性能瓶颈），支持局部矩阵块直接写入全局稀疏结构。

- 并行组装：

    - 共享内存（OpenMP）：多核并行累加单元矩阵，适配单机大规模问题；

    - 分布式内存（MPI）：域分解后，各进程负责局部矩阵组装，自动处理跨进程边界耦合（对标Maxwell的分布式求解）。

- 零元素过滤：组装时自动剔除数值接近零的元素（可设阈值），减少非零元数量，降低内存占用。

- 多单元类型兼容：适配四面体、六面体、棱边元等低频电磁常用单元，自动匹配单元矩阵维度与全局索引。

#### 2. 基础矩阵操作（求解器依赖）

- 核心操作：矩阵-向量乘（MV，迭代法核心）、矩阵-矩阵乘（MM，预处理生成）、矩阵转置、对角元提取/修改、子矩阵提取。

- 电磁专用操作：

    - 散度约束修正：静磁问题中，对奇异矩阵添加罚项/拉格朗日乘子，修复奇异性；

    - 频域复矩阵运算：支持复数矩阵的加减、数乘、共轭转置（涡流场必备）；

    - 时间步进矩阵复用：瞬态场中，支持矩阵不变时仅更新右端项，避免重复组装。

#### 3. 预处理矩阵生成（迭代法关键，对标Maxwell的预处理库）

- 基础预处理：ILU(k)、SSOR、Jacobi（适配小规模/条件数较好矩阵）。

- 电磁专用预处理：

    - 矢量元AMG（代数多重网格）：针对Nedelec边元矩阵，优化粗化策略，解决静磁/涡流矩阵病态问题；

    - 散度预处理：静磁问题专用，约束矢量场散度，提升迭代收敛速度；

    - 块预处理：利用块稀疏结构，做块Jacobi/块ILU，适配矢量元块矩阵。

- 预处理接口：抽象预处理类，支持“生成-应用”分离，可动态切换预处理类型。

### 三、性能层：内存与效率优化（对标Maxwell大规模求解能力）

#### 1. 内存优化

- 压缩存储：对称矩阵仅存半三角、块矩阵压缩块头、非零元用单精度/双精度可选（低频电磁多需双精度，可预留单精度选项）。

- 内存复用：组装时直接写入目标格式（如COO→CSR无拷贝），避免中间临时矩阵；求解时复用向量/矩阵内存，减少动态分配。

- 分布式内存：支持矩阵域分解，各进程仅存储局部矩阵，解决单机内存不足问题（Maxwell核心优势之一）。

#### 2. 计算效率优化

- 缓存友好：矩阵分块（如16x16、32x32）、向量分块，提升MV操作的缓存命中率；

- 指令集优化：利用AVX2/AVX512，加速矩阵数值运算（如块矩阵乘）；

- GPU适配：预留GPU接口，集成cuSPARSE/rocSPARSE，实现GPU加速的MV乘与直接法求解（对标Maxwell的GPU加速模块）。

#### 3. I/O优化

- 矩阵读写：支持二进制格式（自定义高效格式）与标准格式（MatrixMarket、HB），方便测试与第三方工具对接；

- 并行I/O：分布式场景下，多进程并行读写矩阵，避免单进程I/O瓶颈；

- 增量保存：支持矩阵部分更新后增量保存，适配瞬态场时间步进场景。

### 四、场景层：低频电磁专用适配（对标Maxwell物理场求解）

#### 1. 分物理场矩阵设计

- 静电场：实对称正定矩阵（标量节点元），支持Dirichlet/Neumann边界，矩阵对角元主导，易收敛；

- 静磁场：实对称半正定矩阵（矢量边元），易奇异，需散度约束预处理，支持电流源激励；

- 涡流场（频域）：复对称矩阵（矢量边元），需复矩阵运算与复预处理，支持导体损耗计算；

- 瞬态场：实矩阵（时间步进），支持矩阵复用、时间导数项组装（如质量矩阵+刚度矩阵）。

#### 2. 激励与边界条件集成

- 激励源：电流源、电压源、磁通量源直接映射为矩阵右端项（RHS），支持RHS与矩阵同步组装；

- 边界条件：Dirichlet边界自动修改矩阵（行/列置零+对角置1），Neumann边界自动累加单元矩阵贡献，周期性边界自动复制矩阵块。

#### 3. 后处理矩阵适配

- 子矩阵提取：支持按区域/物理量提取子矩阵，用于局部后处理（如某导体的电感矩阵）；

- 灵敏度分析：预留矩阵导数接口，支持参数化扫描（如尺寸变化→矩阵自动更新）。

### 五、工程层：接口、可靠性与扩展性（小白友好+工业级鲁棒性）

#### 1. 易用性接口设计

- C++核心API：封装SparseMatrix类，提供简洁接口（如`add_block()`、`assemble()`、`mult_vec()`、`set_preconditioner()`），隐藏底层格式细节；

- Python绑定：用pybind11封装，支持脚本调用（对标Maxwell的Scripting API），方便小白快速验证算例；

- 可视化工具：集成矩阵非零模式可视化、条件数计算、残差监控，辅助调试。

#### 2. 可靠性与鲁棒性

- 错误检测：组装时检测索引越界、重复赋值、负对角元（电磁矩阵多为正对角），求解时检测奇异矩阵、迭代不收敛；

- 容错机制：迭代法不收敛时自动切换直接法，病态矩阵自动启用强预处理（如AMG）；

- 测试体系：内置标准电磁算例（如平行板电容、螺线管电感、圆柱涡流），验证矩阵组装与求解正确性。

#### 3. 扩展性与兼容性

- 第三方库集成：抽象求解器接口，兼容MUMPS、SuperLU、PETSc、Trilinos等成熟稀疏矩阵求解库（Maxwell底层依赖此类库）；

- 模块化设计：矩阵模块与网格、物理场、后处理解耦，新增单元/求解器时无需修改核心矩阵代码；

- 版本兼容：支持矩阵文件版本管理，避免升级后旧文件无法读取。

### 六、小白开发优先级建议

1. 先实现**基础CSR+COO格式**+**串行组装**+**MUMPS直接法**，跑通静电/静磁基础算例；

2. 再优化**对称压缩**+**DOF重排序**+**基础预处理（ILU）**，提升小规模问题效率；

3. 逐步扩展**块稀疏**+**矢量元适配**+**迭代法（CG/BiCGStab）**，覆盖涡流场；

4. 最后加入**并行组装**+**分布式求解**+**GPU适配**，对标Maxwell大规模求解能力。

### 关键参考（对标Maxwell）

- 矩阵结构：参考Maxwell的“矢量元稀疏矩阵+自动重排序+域分解”架构；

- 求解器：Maxwell混合使用直接法（MUMPS/Pardiso）+迭代法（AMG加速），可复用此策略；

- 电磁优化：重点复现Maxwell的“静磁散度约束”“涡流复矩阵预处理”两大核心特性。

以上覆盖了稀疏矩阵设计的全维度因素，小白可按“基础→性能→场景→扩展”逐步落地，每一步都对标Maxwell的核心功能，确保最终软件的实用性与竞争力。
> （注：文档部分内容可能由 AI 生成）